---
# tasks file for configubuntupache
- name: Stopping firewall
  service:
    name: ufw
    state: stopped
    enabled: no

- name: Start and Enable Apache service
  service:
    name: apache2
    state: started
    enabled: yes

- name: Starting firewall
  service:
    name: ufw
    state: started
    enabled: yes

- name: Set logging to firewall
  ufw:
    logging: on

- name: Allowing Apache2 to firewall
  ufw:
    rule: allow
    name: 'Apache'

- name: Restarting firewall
  service:
    name: ufw
    state: restarted

- name: "Create /var/www/{{ domain }}/ for domain config"
  file:
    path: "/var/www/{{ domain }}"
    state: directory
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: '0755'

- name: Copy conf file to /etc/apache2/sites-available
  copy:
    src: "{{ ubuntu_src }}"
    dest: "/etc/apache2/sites-available/{{ domain }}.conf"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: '0755'
  register: result

- name: Set new virtual host above default
  shell: "a2ensite {{ domain }}; a2dissite 000-default"
  when: result.changed

- name: Copy index.html to webserver
  copy:
    src: index.html
    dest: "/var/www/{{ domain }}/index.html"
    owner: "{{ owner }}"
    group: "{{ group }}"
    mode: '0755'
  register: index_html

- name: Restart Apache2 for changes
  service:
    name: apache2
    state: restarted
  when: index_html.changed

