---
# tasks file for nagios_ubuntu
- name: Install dependencies of Nagios for Ubuntu
  apt:
    name:
      - autoconf
      - gcc
      - libc6
      - make
      - wget
      - libssl-dev
      - gawk
      - dc
      - build-essential
      - snmp
      - libnet-snmp-perl
      - gettext
      - unzip
      - apache2
      - php
      - libapache2-mod-php7.4
      - libgd-dev
      - python3
      - python3-pip
    state: latest
    
- name: Pip install passlib
  pip:
    name: passlib
    state: present

- name: Download and uncompress Nagios files from web
  unarchive:
    src: https://github.com/NagiosEnterprises/nagioscore/archive/nagios-4.4.5.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Create Make file in /tmp/nagioscore
  shell: cd /tmp/nagioscore-nagios-4.4.5; sh /tmp/nagioscore-nagios-4.4.5/configure --with-httpd-conf=/etc/apache2/sites-enabled

- name: Compile files together
  make:
    chdir: /tmp/nagioscore-nagios-4.4.5/
    target: all

- name: Create the user and group for nagios
  make:
    chdir: /tmp/nagioscore-nagios-4.4.5
    target: install-groups-users

- name: Add www-data(Apache)  user to nagios group
  user:
    name: www-data
    groups: nagios
    append: yes

- name: Install binaries
  make:
    chdir: /tmp/nagioscore-nagios-4.4.5
    target: install

- name: Install service/daemon
  make:
    chdir: /tmp/nagioscore-nagios-4.4.5
    target: install-daemoninit

- name: Install command mode
  make:
    chdir: /tmp/nagioscore-nagios-4.4.5
    target: install-commandmode

- name: Install configuration files
  make:
    chdir: /tmp/nagioscore-nagios-4.4.5
    target: install-config

- name: Install Apache config files
  make:
    chdir: /tmp/nagioscore-nagios-4.4.5
    target: install-webconf

- name: Enable the rewrite module using apache
  apache2_module:
    state: present
    name: rewrite

- name: Enable the cgi module using apache
  apache2_module:
    state: present
    name: cgi

- name: Create admin username and password for authentication
  htpasswd:
    path: /usr/local/nagios/etc/htpasswd.users
    name: admin12345
    password: admin12345

- name: Restart apache2
  service:
    name: apache2
    state: restarted

- name: Start and enable nagios
  service:
    name: nagios
    state: started
    enabled: yes

- name: Download and unarchive Nagios Plugins
  unarchive:
    src: https://github.com/nagios-plugins/nagios-plugins/archive/release-2.2.1.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Create Make file
  shell: cd /tmp/nagios-plugins-release-2.2.1; sh /tmp/nagios-plugins-release-2.2.1/tools/setup; sh /tmp/nagios-plugins-release-2.2.1/configure

- name: Compile from source
  make:
    chdir: /tmp/nagios-plugins-release-2.2.1/

- name: Compile from source
  make:
    chdir: /tmp/nagios-plugins-release-2.2.1/
    target: install

- name: Restart Nagios
  service:
    name: nagios
    state: restarted
