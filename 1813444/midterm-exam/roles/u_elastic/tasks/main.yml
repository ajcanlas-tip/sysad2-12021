---
# tasks file for roles/u_elastic

- name: install java and nginx 
  apt: 
    name:
      - openjdk-11-jdk 
      - nginx 
    state: latest 
    update_cache: yes   
    

- name: elastic repository 
  apt_key: 
    url: "https://packages.elastic.co/GPG-KEY-elasticsearch"
    state: present

- name: Installation of apt repo
  apt: 
    name: apt-transport-https 
    state: latest
    update_cache: yes 

- name: getting apt transport https 
  apt_repository: 
    filename: elastic-7.x 
    repo: deb https://artifacts.elastic.co/packages/7.x/apt stable main 
    state: present 

- name: Installation of ES 
  apt: 
    name: elasticsearch 
    state: present 
    update_cache: yes 

- name: updating of configuration file 
  lineinfile: 
    destfile: /etc/elasticsearch/elasticsearch.yml 
    regexp: 'network.host'
    line: 'network.host: "0.0.0.0"'

- name: configuration of port
  lineinfile: 
    destfile: /etc/elasticsearch/elasticsearch.yml 
    regexp: 'http.port'
    line: 'http.port: 9200' 

- name: add disc type 
  lineinfile: 
    destfile: /etc/elasticsearch/elasticsearch.yml 
    line: 'discovery.type: "single-node"'

- name: JVM heap size 
  lineinfile: 
    dest: /etc/elasticsearch/jvm.options 
    regexp: '-Xms'
    line: '-Xms512m' 

- name: JVM maximum
  lineinfile: 
    dest: /etc/elasticsearch/jvm.options
    regexp: '-Xmx' 
    line: '-Xmx512m' 

- name: disabling ufw 
  service:
    name: ufw
    state: stopped
    enabled: no 

- name: enabling ES 
  service: 
    name: elasticsearch 
    state: started 
    enabled: yes 

- name: installation of kibana 
  apt: 
    name: kibana
    state: latest
    update_cache: yes 

- name: removing hashtag
  lineinfile: 
    dest: /etc/kibana/kibana.yml 
    regexp: '#elasticsearch.hosts:'
    line: 'elasticsearch.hosts: ["http://0.0.0.0:9200"]'

- name: enabling kibana
  service: 
    name: kibana 
    state: started 
    enabled: yes 

- name: allow ufw 
  command: ufw allow 5601/tcp 

- name: Installation of logstash 
  apt: 
    name: logstash 
    state: latest 
    update_cache: yes 

- name: start install logstash 
  service: 
    name: logstash 
    state: started 
    enabled: yes 

























