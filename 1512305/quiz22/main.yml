---

  - name: Install Apache
    hosts: all
    tasks:
      - name: Installing Apache
        apt:
          name: apache2
          state: latest
          update_cache: yes
 
      - name: Apache_index
        copy:
          content: "KAWASAKI NINJA 400"
          dest: /var/www/html/index.html
          owner: root
          group: root
          mode: '0644'
        register: apache_index

      - name: start apache2 service
        service:
          name: apache2
          state: restarted
          enabled: yes
        when: apache_index.changed
      - name: whitelist apache2 in ufw
        ufw:
          rule: allow
          port: '80'
          proto: tcp

  - name: check web service if up
    hosts: localhost
    connection: local
    become: no

    tasks:
    - name: check web service if up
      uri:
        url: http://www.example.com

  - name: Install and Configure MySQL
    hosts: all

    tasks:
      - name: Mysql-server
        apt:
          name: mysql-server
          state: latest
          update_cache: yes
      - name: Mysql host index
        copy:
          content: "NINJA 400"
          dest: /var/www/html/index1.html
          owner: root
          group: root
          mode: '0644'
        register: mysql_index
      - name: Start MySQL service
        service:
          name: mysql
          state: restarted
          enabled: yes
        when: mysql_index.changed

  - name: Install and Configure PHP
    hosts: all
    tasks:
      - name: Installing PHP
        apt:
          name:
            - php
            - php-mysql
            - libapache2-mod-php
          state: latest
          update_cache: yes
      - name: Php_index
        copy:
          content: "NINJA 400"
          dest: /var/www/index2.html
          owner: root
          group: root
          mode: '0644'
