---
  - name: Quiz 2.2 Ansible Playbooks
    hosts: ubuntu
    
    tasks:
    - name: Include db authentication
      include_vars:
        file: vars/db_config_vars.yaml


    - name: Install Apache2
      apt:
        name: apache2
        state: latest
        update_cache: yes
    
    - name: Allow HTTP on Port 80
      ufw:
        rule: allow
        port: "80"
        proto: tcp

    - name: Start and enable Apache service
      service:
        name: apache2
        state: started
        enabled: yes

    - name: Install MySQL
      apt:
        name: mysql-server
        state: present
        update_cache: yes
   
    - name: Start MySQL server
      service:
        name: mysql
        state: started
        enabled: yes

    - name: Install PHP
      apt:
        name:
          - php
          - libapache2-mod-php
          - php-mysql
        state: present
        update_cache: yes
    
    - name: Create /var/www/jpcabral-tip/ for domain config
      file:
        path: /var/www/jpcabral-tip
        state: directory
        owner: jpcabral-tip
        group: jpcabral-tip
        mode: '0755'

    - name: Copy jpcabral-tip.conf to /etc/apache2/sites-available/jpcabral-tip.conf
      copy:
        src: jpcabral-tip.conf
        dest: /etc/apache2/sites-available/jpcabral-tip.conf
        owner: jpcabral-tip
        group: jpcabral-tip
        mode: '0755'

    - name: a2ensite jpcabral-tip
      shell: "a2ensite jpcabral-tip; a2dissite 000-default"
      notify:
      - Restart Apache

    - name: New index.html
      copy:
        src: index.html
        dest: /var/www/jpcabral-tip/index.html
        owner: jpcabral-tip
        group: jpcabral-tip
        mode: '0755'
      notify:
      - Restart Apache
    
    - name: Create info.php on /var/www/jpcabral-tip/
      copy:
        content: "<?php phpinfo();"
        dest: /var/www/jpcabral-tip/info.php
        owner: jpcabral-tip
        group: jpcabral-tip
        mode: '0755'
      notify:
      - Restart Apache

    # OPTIONAL PHP MYSQL TASKS??
    - name: Install MySQL module requirements
      apt:
        name:
          - python3
          - python3-pymysql
        state: latest
        update_cache: yes
    
    - name: Install pip requirements for MySQL module
      pip:
        name:
          - pymysql
    
    - name: Create MySQL user
      shell: mysql -e "CREATE USER IF NOT EXTSTS '{{ db_user }}'@'localhost' IDENTIFIED WITH mysql_native_password BY '{{ db_pass }}'"; mysql -e "CREATE USER IF NOT EXISTS '{{ db_user }}'@'%' IDENTIFIED WITH mysql_native_password BY '{{ db_pass }}'"
    
    - name: Escalate created MySQL user
      shell: set -f; mysql -e "GRANT ALL PRIVILEGES ON *.* TO '{{ db_user }}'@'localhost'"; mysql -e "GRANT ALL PRIVILEGES ON *.* TO '{{ db_user }}'@'%'"

    - name: Create example_database
      mysql_db:
        login_host: "{{ db_host }}"
        login_user: "{{ db_user }}"
        login_password:  "{{ db_pass }}"
        name: example_database
        state: present
    
    - name: Copy the SQL script on remote host
      copy:
        src: db.sql
        dest: "~"
        owner: jpcabral-tip
        group: jpcabral-tip
        mode: '0775'
      register: sqlFile

    - name: Import SQL
      mysql_db:
        login_host: "{{ db_host }}"
        login_user: "{{ db_user }}"
        login_password: "{{ db_pass }}"
        state: import
        name: all
        target: "~/db.sql"
      when: sqlFile.changed

    - name: Copy todo_list.php
      copy:
        src: todo_list.php
        dest: /var/www/jpcabral-tip/todo_list.php
        owner: jpcabral-tip
        group: jpcabral-tip
        mode: '0755'
      notify:
      - Restart Apache

    handlers:
      - name: Restart Apache
        service:
          name: apache2
          state: restarted
